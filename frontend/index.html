<!DOCTYPE html>
<html>
  <head>
    <title>Carte Stations-service</title>
    <meta name="viewport" content="initial-scale=1.0" />
    <meta charset="utf-8" />
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <button class="toggle-btn" onclick="toggleFilters()">☰ Filtres</button>

    <!-- Nouveau bouton pour la route -->
    <div class="filters-panel" id="filtersPanel">
      <button class="route-btn" id="routeToggleBtn">Afficher Route</button>

      <div class="filters-header">
        Filtres
        <button class="close-btn" onclick="toggleFilters()">×</button>
      </div>

      <!-- Nouvelle section pour la route -->
      <div class="filter-section">
        <div class="filter-title route">Route</div>
        <div class="filter-option">
          <input type="checkbox" id="show-route" checked />
          <label for="show-route"
            >Afficher la route Andoharanofotsy - Analakely</label
          >
        </div>
        <div
          style="margin-top: 8px; font-size: 12px; color: #666"
          id="routeInfo"
        >
          Chargement des informations de la route...
        </div>
      </div>

      <!-- Filtre par nom de station -->
      <div class="filter-section">
        <div class="filter-title search">Rechercher une station</div>
        <input
          type="text"
          class="search-input"
          id="stationSearch"
          placeholder="Tapez le nom de la station..."
        />
      </div>

      <!-- Opérateurs -->
      <div class="filter-section">
        <div class="filter-title operator">Opérateurs</div>

        <div class="filter-option">
          <input type="checkbox" id="operator-Jovena" />
          <label for="operator-Jovena">Jovena</label>
        </div>

        <div class="filter-option">
          <input type="checkbox" id="operator-Galana" />
          <label for="operator-Galana">Galana</label>
        </div>

        <div class="filter-option">
          <input type="checkbox" id="operator-Total" />
          <label for="operator-Total">Total</label>
        </div>

        <div class="filter-option">
          <input type="checkbox" id="operator-Shell" />
          <label for="operator-Shell">Shell</label>
        </div>
      </div>
      </div>
    </div>

    <div id="map"></div>

    <script type="module" src="js/app.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const routeBtn = document.getElementById("routeToggleBtn");

        const waitForApp = setInterval(() => {
          if (
            window.app &&
            typeof window.app.toggleRouteDisplay === "function"
          ) {
            clearInterval(waitForApp);

            // Ajoute le gestionnaire d'événement proprement
            let routeVisible = true;

            routeBtn.addEventListener("click", () => {
              routeVisible = !routeVisible;
              window.app.toggleRouteDisplay(routeVisible);

              // UI update
              routeBtn.textContent = routeVisible
                ? "Masquer Route"
                : "Afficher Route";
              routeBtn.style.backgroundColor = routeVisible
                ? "#f44336"
                : "#4CAF50";
              const checkbox = document.getElementById("show-route");
              if (checkbox) checkbox.checked = routeVisible;
            });
          }
        }, 100); // Vérifie toutes les 100ms

        // Timeout fail-safe après 10s
        setTimeout(() => clearInterval(waitForApp), 10000);
      });
    </script>

    <!-- API Google Maps -->
    <script
      src="https://cdn.jsdelivr.net/gh/somanchiu/Keyless-Google-Maps-API@v7.0/mapsJavaScriptAPI.js"
      async
      defer
    ></script>

    <script>
      let routeVisible = true;

      function toggleFilters() {
        const panel = document.getElementById("filtersPanel");
        panel.classList.toggle("hidden");
      }

      function testRoute() {
        console.log("Test de la route...");
        if (window.app) {
          window.app.debugRoute();

          // Tester l'API directement
          fetch("http://localhost:3000/api/route")
            .then((response) => response.json())
            .then((data) => {
              console.log("Données de route depuis API:", data);
            })
            .catch((error) => {
              console.error("Erreur API route:", error);
            });
        }
      }

      function toggleRoute() {
        console.log("toggleRoute appelé, état actuel:", routeVisible);

        routeVisible = !routeVisible;
        const btn = document.getElementById("routeToggleBtn");
        const checkbox = document.getElementById("show-route");

        // Mettre à jour l'interface
        if (routeVisible) {
          btn.textContent = "Masquer Route";
          btn.style.backgroundColor = "#f44336";
          if (checkbox) checkbox.checked = true;
        } else {
          btn.textContent = "Afficher Route";
          btn.style.backgroundColor = "#4CAF50";
          if (checkbox) checkbox.checked = false;
        }

        // Appeler la méthode de l'app
        if (window.app) {
          window.app.toggleRouteDisplay(routeVisible);
        } else {
          console.error("window.app non disponible");
        }

        console.log("État après toggle:", routeVisible);
      }
    </script>
  </body>
</html>
