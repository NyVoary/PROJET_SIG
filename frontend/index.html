<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte Stations-service</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="panel-visible">
  <div class="container">    
    <aside class="panel">
      <div class="filters-header">
        <div class="filters-title">Filtres et Options</div>
        <button class="close-btn" id="closePanelBtn" onclick="toggleFilters()">×</button>
      </div>
      
      <div class="filter-section">
        <div class="filter-title">Affichage de la route</div>
        <button id="routeToggleBtn" class="toggle-btn">
          <span id="routeIcon">✓</span>
          <span id="routeText">Masquer la Route</span>
        </button>
      </div>
      
      <div class="route-info">
      <div id="routeInfo">
        <!-- Le contenu sera injecté ici par updateRouteInfo -->
      </div>
      </div>
      
      <div class="filter-section">
        <div class="filter-title">Rechercher une station</div>
        <input 
          type="text" 
          class="search-input" 
          id="stationSearch" 
          placeholder="Entrez le nom d'une station..."
        />
      </div>
      
      <div class="filter-section">
        <div class="filter-title">Opérateurs</div>
        <div class="operator-list">
          <div class="filter-option">
            <input type="checkbox" id="operator-Jovena">
            <label for="operator-Jovena">Jovena</label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="operator-Galana">
            <label for="operator-Galana">Galana</label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="operator-Total">
            <label for="operator-Total">Total</label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="operator-Shell">
            <label for="operator-Shell">Shell</label>
          </div>
        </div>
      </div>
    </aside>
    
    <main class="map-container">
      <div id="map"></div>
    </main>
  </div>
        
      <script type="module" src="js/app.js"></script>

      <script>
      document.addEventListener("DOMContentLoaded", () => {
        const routeBtn = document.getElementById("routeToggleBtn");

        const waitForApp = setInterval(() => {
          if (
            window.app &&
            typeof window.app.toggleRouteDisplay === "function"
          ) {
            clearInterval(waitForApp);

            // Ajoute le gestionnaire d'événement proprement
            let routeVisible = true;

            routeBtn.addEventListener("click", () => {
              routeVisible = !routeVisible;
              window.app.toggleRouteDisplay(routeVisible);

              // UI update
              if (routeVisible) {
                routeToggleBtn.classList.remove('route-active');
                routeIcon.textContent = '✓';
                routeText.textContent = 'Masquer la Route';
              } else {
                routeToggleBtn.classList.add('route-active');
                routeIcon.textContent = '✕';
                routeText.textContent = 'Afficher la Route';
              }

              const checkbox = document.getElementById("show-route");
              if (checkbox) checkbox.checked = routeVisible;
            });
          }
        }, 100); // Vérifie toutes les 100ms

        // Timeout fail-safe après 10s
        setTimeout(() => clearInterval(waitForApp), 10000);
      });
    </script>

    <!-- API Google Maps -->
    <script
      src="https://cdn.jsdelivr.net/gh/somanchiu/Keyless-Google-Maps-API@v7.0/mapsJavaScriptAPI.js"
      async
      defer
    ></script>

    <script>
      let routeVisible = true;

      function toggleFilters() {
        const panel = document.getElementById("filtersPanel");
        panel.classList.toggle("hidden");
      }

      function testRoute() {
        console.log("Test de la route...");
        if (window.app) {
          window.app.debugRoute();

          // Tester l'API directement
          fetch("http://localhost:3000/api/route")
            .then((response) => response.json())
            .then((data) => {
              console.log("Données de route depuis API:", data);
            })
            .catch((error) => {
              console.error("Erreur API route:", error);
            });
        }
      }

      function toggleRoute() {
        console.log("toggleRoute appelé, état actuel:", routeVisible);

        routeVisible = !routeVisible;
        const btn = document.getElementById("routeToggleBtn");
        const checkbox = document.getElementById("show-route");

        // Mettre à jour l'interface
        if (routeVisible) {
          btn.textContent = "Masquer la Route";
          btn.classList.remove("route-active");
          if (checkbox) checkbox.checked = true;
        } else {
          btn.textContent = "Afficher la Route";
          btn.classList.add("route-active");
          if (checkbox) checkbox.checked = false;
        }


        // Appeler la méthode de l'app
        if (window.app) {
          window.app.toggleRouteDisplay(routeVisible);
        } else {
          console.error("window.app non disponible");
        }

        console.log("État après toggle:", routeVisible);
      }
    </script>
</body>
</html>